<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Sending Authentication Requests OpenID Connect Using Request Parameters</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Sending Authentication Requests OpenID Connect Using Request Parameters | WildFly Elytron</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Sending Authentication Requests OpenID Connect Using Request Parameters" />
<meta name="author" content="Prarthona Paul" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="WildFly 32 includes the ability to send the request object as a Json Web Token (JWT) when securing an application using OIDC. The feature also includes the ability to sign and/or encrypt the JWT for added security. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OAuth 2.0 request syntax sends the Request Object in the request by adding them directly to the URL. However, OpenID Connect allows the Request Object to be sent as a JWT using request parameters, which can be signed and optionally encrypted. This adds an added layer of protection, as the parameters are no longer human-readable." />
<meta property="og:description" content="WildFly 32 includes the ability to send the request object as a Json Web Token (JWT) when securing an application using OIDC. The feature also includes the ability to sign and/or encrypt the JWT for added security. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OAuth 2.0 request syntax sends the Request Object in the request by adding them directly to the URL. However, OpenID Connect allows the Request Object to be sent as a JWT using request parameters, which can be signed and optionally encrypted. This adds an added layer of protection, as the parameters are no longer human-readable." />
<link rel="canonical" href="https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/" />
<meta property="og:url" content="https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/" />
<meta property="og:site_name" content="WildFly Elytron" />
<meta property="og:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="twitter:title" content="Sending Authentication Requests OpenID Connect Using Request Parameters" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Prarthona Paul"},"dateModified":"2023-09-29T00:00:00+00:00","datePublished":"2023-09-29T00:00:00+00:00","description":"WildFly 32 includes the ability to send the request object as a Json Web Token (JWT) when securing an application using OIDC. The feature also includes the ability to sign and/or encrypt the JWT for added security. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OAuth 2.0 request syntax sends the Request Object in the request by adding them directly to the URL. However, OpenID Connect allows the Request Object to be sent as a JWT using request parameters, which can be signed and optionally encrypted. This adds an added layer of protection, as the parameters are no longer human-readable.","headline":"Sending Authentication Requests OpenID Connect Using Request Parameters","image":"https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/"},"url":"https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                    
                         <a class="mdl-navigation__link highlight-button Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link CVE Reporting-menuitem" href="/wildfly-elytron/security/">CVE Reporting</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
            
                <a class="mdl-navigation__link highlight-sidebar Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
            
            
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
            
                <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
            
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            
            
            
                <a class="mdl-navigation__link CVE Reporting-menuitem" href="/wildfly-elytron/security/">CVE Reporting</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Sending Authentication Requests OpenID Connect Using Request Parameters</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/6ed81e314d6074bbf734abe812f33b05">
        
        <p class="byline">
          By <a href="https://github.com/PrarthonaPaul">Prarthona Paul</a> | September 29, 2023
          <br>
          
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/oidc"> #oidc</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/keycloak"> #keycloak</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/jwt"> #jwt</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/encryption"> #encryption</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/authentication"> #authentication</a>
            
          
        </p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/&title=Sending Authentication Requests OpenID Connect Using Request Parameters" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Sending Authentication Requests OpenID Connect Using Request Parameters&url=https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Sending Authentication Requests OpenID Connect Using Request Parameters&amp;body=Sending Authentication Requests OpenID Connect Using Request Parameters https://wildfly-security.github.io/wildfly-elytron/blog/oidc-cient-request/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>WildFly 32 includes the ability to send the request object as a Json Web Token (JWT) when securing an application using OIDC.
The feature also includes the ability to sign and/or encrypt the JWT for added security. <a href="https://openid.net/developers/how-connect-works/">OpenID Connect</a> is an identity layer on top of the OAuth 2.0 protocol
that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID
provider. The OAuth 2.0 request syntax sends the Request Object in the request by adding them directly to the URL.
However, OpenID Connect allows the Request Object to be sent as a JWT using <a href="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests">request parameters</a>, which can be signed and optionally
encrypted. This adds an added layer of protection, as the parameters are no longer human-readable.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#example-application">Example Application</a></li>
<li><a href="#setting-up-the-keypairs">Setting up the KeyPairs</a>
<ul class="sectlevel2">
<li><a href="#about-key-pairs">About Key Pairs</a></li>
<li><a href="#generating-key-pairs">Generating Key Pairs</a></li>
</ul>
</li>
<li><a href="#log-into-the-openshift-cluster">Log Into the OpenShift Cluster</a></li>
<li><a href="#start-keycloak">Start Keycloak</a>
<ul class="sectlevel2">
<li><a href="#openshift-cli">OpenShift CLI</a></li>
<li><a href="#openshift-web-console">OpenShift Web Console</a></li>
</ul>
</li>
<li><a href="#setting-up-keycloak-openid-provider">Setting up Keycloak OpenID Provider</a></li>
<li><a href="#create-an-openshift-secret">Create an OpenShift Secret</a></li>
<li><a href="#add-helm-configuration">Add Helm Configuration</a></li>
<li><a href="#deployment-configuration">Deployment Configuration</a></li>
<li><a href="#deploying-and-accessing-the-application">Deploying and Accessing the Application</a>
<ul class="sectlevel2">
<li><a href="#sending-the-jwt-by-reference">Sending the JWT by Reference</a></li>
<li><a href="#sending-a-signed-and-encrypted-request">Sending a Signed and Encrypted Request</a></li>
<li><a href="#note-about-keystores">Note about Keystores</a></li>
<li><a href="#restoring-the-server">Restoring the server</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To follow along with this guide, you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roughly 15 minutes</p>
</li>
<li>
<p>Access to an OpenShift cluster (try the Red Hat Developer Sandbox for free)</p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.15/cli_reference/openshift_cli/getting-started-cli.html">OpenShift CLI</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Helm Chart</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example-application"><a class="anchor" href="#example-application"></a>Example Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use a simple web application in this guide that consists of a <a href="https://github.com/wildfly-security-incubator/elytron-examples/blob/main/elytron-oidc-request/src/main/java/org/wildfly/security/examples/SecuredServlet.java">single servlet</a>. We will secure this servlet using OIDC.</p>
</div>
<div class="paragraph">
<p>We will use the example in the <a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/elytron-oidc-request">elytron-oidc-request</a> directory in this repo.</p>
</div>
<div class="paragraph">
<p>To obtain this example, clone the elytron-examples repository to your local machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">git clone git@github.com:wildfly-security-incubator/elytron-examples.git</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-the-keypairs"><a class="anchor" href="#setting-up-the-keypairs"></a>Setting up the KeyPairs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order for us to sign the JWT&#8217;s, we will need to use key pairs corresponding to the algorithms specified. These are tokens communicated between the client and the server and are used to sign and encrypt JWT&#8217;s.</p>
</div>
<div class="sect2">
<h3 id="about-key-pairs"><a class="anchor" href="#about-key-pairs"></a>About Key Pairs</h3>
<div class="paragraph">
<p>Typically key pairs have 3 components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Private Key:</strong> This is the part of the key that must be kept secret and will be used to sign the JWT. Your OpenID provider communicates the public key of some keyPair(s) to you. The public key is used by you to encrypt the JWT.</p>
</li>
<li>
<p><strong>Public Key:</strong> This is the part of the keypair that is communicated to trusted parties. We use the public key that the OpenID provider shares with us to encrypt our JWT&#8217;s. Public keys can be extracted from the certificate.</p>
</li>
<li>
<p><strong>Certificate:</strong> This is used to verify the signatures among other things. This is communicated to the OpenID provider. Certificate contains the public key.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keypairs with public and private keys are known as <strong>asymmetric</strong> keys. Some keys are <strong>symmetric</strong>, meaning they only have 1 secret key that is used by both the client and the server. Each key has an algorithm that is used to generate it, such as, RSA, Elliptic Curve, etc. An example of a symmetric algorithm is HS256, where the same key is used to sign a JWT and verify the signature.</p>
</div>
</div>
<div class="sect2">
<h3 id="generating-key-pairs"><a class="anchor" href="#generating-key-pairs"></a>Generating Key Pairs</h3>
<div class="paragraph">
<p>We can use the <code>keytool</code> tool in the cli to generate our keys and store them in a keystore file. We can generate keystore files of type <code>JKS</code> and <code>PKCS12</code> for our application. The general format for doing this is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    $ keytool -genkeypair -alias &lt;keystore_alias&gt; -keyalg &lt;algorithm&gt; -keysize &lt;key_size&gt; -validity &lt;validity_in_days&gt;
-keystore &lt;keystore_name&gt; -dname "&lt;distinguished_name&gt;" -keypass &lt;private_key_password&gt; -storepass &lt;keystore_password&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="generating-pkcs12-keystore"><a class="anchor" href="#generating-pkcs12-keystore"></a>Generating PKCS12 Keystore</h4>
<div class="paragraph">
<p>Let us first create a PKCS12 keystore file with 2 different keys. Let&#8217;s first generate an RSA keyPair:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    $ keytool -genkeypair -alias rsaKey -keyalg RSA -keysize 2048 -validity 365 -keystore Keycloak.keystore.pkcs12 -dname "CN=client" -keypass password -storepass password</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for Elliptical Curve keys, use the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    $ keytool -genkeypair -alias ecKey -keyalg EC -groupname secp256r1 -validity 365 -keystore Keycloak.keystore.pkcs12 -dname "CN=client" -keypass password -storepass password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in this case, we have specified the <strong>key size</strong> for the RSA keys, and the <strong>groupname</strong> for Elliptical Curve keys.
For the RSA keys, the same keysize can be used for RSA algorithms with different SHA values (i.e. RSA256, RSA512).
However, this is not the case for Elliptical Curve keys. For ES256 algorithms, you need to use the groupname associated with the SHA value (i.e. <code>-groupname secp256r1</code> and for ES384, use <code>-groupname secp384r1</code> and so on).</p>
</div>
<div class="paragraph">
<p>If you would like to use JKS keystore files instead, see <a href="https://docs.redhat.com/en/documentation/red_hat_jboss_data_virtualization/6.4/html/security_guide/create_a_privatepublic_key_pair_with_keytool">here</a> for more information.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="log-into-the-openshift-cluster"><a class="anchor" href="#log-into-the-openshift-cluster"></a>Log Into the OpenShift Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we can deploy our application, we need to log into an OpenShift cluster. You can log in via the OpenShift CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc login -u myUserName</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to log in using the API token, navigate to Developer Sandbox, click on your username at the top right corner, and click on Copy login command. It will redirect you to a page where you can copy your login command and paste it on your terminal. The command will be in this format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc login --token=myToken --server=myServerUrl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have your environment set up with the required tools, we can move on to the next step to build and deploy our application on OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="start-keycloak"><a class="anchor" href="#start-keycloak"></a>Start Keycloak</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will be using Keycloak as our OpenID identity provider.</p>
</div>
<div class="paragraph">
<p>To start a Keycloak server in your project on OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc process -f https://raw.githubusercontent.com/keycloak/keycloak-quickstarts/latest/openshift/keycloak.yaml \
    -p KEYCLOAK_ADMIN=admin \                 <i class="conum" data-value="1"></i><b>(1)</b>
    -p KEYCLOAK_ADMIN_PASSWORD=admin \        <i class="conum" data-value="2"></i><b>(2)</b>
    -p NAMESPACE=&lt;PROJECT_NAME&gt; \               <i class="conum" data-value="3"></i><b>(3)</b>
| oc create -f -</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace admin with the user name you would like to use when accessing the Keycloak Administration Console.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace admin with the password you would like to use when accessing the Keycloak Administration Console.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace &lt;PROJECT_NAME&gt; with your project name.
After running the above command, you should see the following output:</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">service/keycloak created
route.route.openshift.io/keycloak created
Warning: apps.openshift.io/v1 DeploymentConfig is deprecated in v4.14+, unavailable in v4.10000+
deploymentconfig.apps.openshift.io/keycloak created.</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will take a few minutes for OpenShift to provision the Keycloak pod and its related resources.</p>
</div>
<div class="paragraph">
<p>You can use the OpenShift CLI or the OpenShift web console, depending on your preference, to check if your Keycloak server has been provisioned.</p>
</div>
<div class="sect2">
<h3 id="openshift-cli"><a class="anchor" href="#openshift-cli"></a>OpenShift CLI</h3>
<div class="paragraph">
<p>To make sure your Keycloak server has been provisioned using the OpenShift CLI, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a little while, check for a message similar to the following message that indicates the pod is ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                READY     STATUS      RESTARTS   AGE
keycloak-1-deploy   0/1       Completed   0          1h
keycloak-1-l9kdx    1/1       Running     0          1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Keycloak server has been provisioned, use the following command to find the URL for your Keycloak instance’s Admin Console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">KEYCLOAK_URL=https://$(oc get route keycloak --template='{{ .spec.host }}') &amp;&amp;
echo "" &amp;&amp;
echo "Keycloak Admin Console:   $KEYCLOAK_URL/admin" &amp;&amp;
echo ""</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openshift-web-console"><a class="anchor" href="#openshift-web-console"></a>OpenShift Web Console</h3>
<div class="paragraph">
<p>To make sure your Keycloak server has been provisioned using the OpenShift web console, navigate to the <strong>Topology</strong> view in the <strong>Developer</strong> perspective. You can click on your <strong>keycloak</strong> app to check its status. Once it is running, you can click on <strong>Open URL</strong> and then access Keycloak’s <strong>Administration Console</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-keycloak-openid-provider"><a class="anchor" href="#setting-up-keycloak-openid-provider"></a>Setting up Keycloak OpenID Provider</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the Keycloak Admin Console using the admin username and password you specified earlier.</p>
</li>
<li>
<p>Next, create a realm called <strong>myrealm</strong> and register a client called <strong>myclient</strong> as follows:
<strong>General settings</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Client type</strong> (or <strong>Client Protocol</strong>, depending on your keycloak version): <strong>OpenID Connect</strong></p>
</li>
<li>
<p><strong>Client ID</strong>: <strong>myclient</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Capability config</strong>:</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Client authentication</strong> : <strong>On</strong></p>
</li>
<li>
<p><strong>Authentication flow</strong>: <strong>Standard flow, Direct access grants</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Login Settings</strong>: For the <strong>Valid Redirect URIs</strong>, enter a * for now. We will come back to edit it later.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Once you hit <strong>Save</strong>, you should see a new tab called <strong>Keys</strong> appear.</p>
</li>
<li>
<p>Navigate to that tab and click on <strong>Import</strong>. Under <strong>Archive format</strong>, choose <strong>PKCS12</strong> from the dropdown. Under <strong>Key alias</strong>,
enter the alias of the RSA key you just created, under <strong>Store password</strong> enter the password of the keystore you created
and click on the <strong>Browse</strong> button to import the keystore file. Note that when we created the keystore, we specified a key
password and a keystore password. Here, we are only using the <strong>keystore password</strong>. While we set them both to be the same,
they do not have to be.</p>
</li>
<li>
<p>Finally, create a user called <code>alice</code> whose <code>First name</code> is Alice and <code>Last name</code> is Smith.</p>
</li>
<li>
<p>Next, navigate to the <code>Credentials</code> tab and create a password for Alice. Toggle the <code>Temporary</code> switch off, so you are
not prompted to update the password after the first login.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-an-openshift-secret"><a class="anchor" href="#create-an-openshift-secret"></a>Create an OpenShift Secret</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since WildFly will use the keystore we created earlier, we need to add it to OpenShift. We can do this by generating an OpenShift secret using the keystore file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    $ oc create secret generic simple-webapp-secret --from-file=/PATH/TO/Keycloak.keystore.pkcs12</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-helm-configuration"><a class="anchor" href="#add-helm-configuration"></a>Add Helm Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Obtain the URL for Keycloak.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">KEYCLOAK_URL=https://$(oc get route keycloak --template='{{ .spec.host }}') &amp;&amp;
echo "" &amp;&amp;
echo "Keycloak URL:   $KEYCLOAK_URL" &amp;&amp;
echo ""</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Switch to the charts directory in the <code>elytron-oidc-client-scope</code> example.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cd /PATH/TO/ELYTRON/EXAMPLES/elytron-oidc-client-scope/charts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice there’s a helm.yaml file in this directory with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">build:
  uri: https://github.com/wildfly-security-incubator/elytron-examples.git
  contextDir: elytron-oidc-client-scope
deploy:
  replicas: 1
  volumes:
    - name: saml-keystore-volume
      secret:
        secretName: simple-webapp-saml-secret
  env:
    - name: OIDC_PROVIDER_URL
      value: &lt;KEYCLOAK_URL&gt;    <i class="conum" data-value="1"></i><b>(1)</b>
    - name: OIDC_CLIENT_SECRET
      value: &lt;CLIENT_SECRET&gt;
    - name: SERVER_ARGS
      value: "--stability=preview"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace &lt;KEYCLOAK_URL&gt; with the Keycloak URL obtained in the previous command.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployment-configuration"><a class="anchor" href="#deployment-configuration"></a>Deployment Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The configuration required to secure an application with OpenID Connect can be specified in the deployment. We will
first be sending a plaintext request, which will be unsigned, signified by the "none" algorithm.</p>
</div>
<div class="paragraph">
<p>The first step is to set up the deployment configuration using the <code>oidc.json</code> file in the <code>WEB-INF</code> directory of this
project. The following will be the contents of the <code>oidc.json</code> file once we have specified the scope values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
    "client-id" : "myclient",
    "provider-url" : "${env.OIDC_PROVIDER_URL:http://localhost:8080}/realms/myrealm",
    "public-client" : "false",
    "authentication-request-format" : "request",
    "request-object-signing-algorithm" : "none",
    "principal-attribute" : "preferred_username",
    "ssl-required" : "EXTERNAL"
    "scope" : "profile email roles web-origins microprofile-jwt offline_access",
    "credentials" : {
    	"secret" : "${env.OIDC_CLIENT_SECRET}"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we have specified the <code>authentication-request-format</code> to be <code>request</code>, meaning, we are sending it by value. We
have specified the signing algorithm to be <code>none</code>. Alternatively, we could not have specified it too, since the default
value is already <code>none</code>. Since we are not signing the JWT, we don&#8217;t need to configure the keystore.</p>
</div>
<div class="paragraph">
<p>Next, navigate to the OIDC application&#8217;s <code>web.xml</code> file and look for the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;login-config&gt;
    &lt;auth-method&gt;OIDC&lt;/auth-method&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you would like to configure the <code>elytron-oidc-client</code> subsystem instead, then follow the steps outlines in the next
section.</p>
</div>
<div class="paragraph">
<p>Note that if you have both the subsystem and the deployment configured, then the <code>elytron-oidc-client</code> subsystem
configuration will override the deployment configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-and-accessing-the-application"><a class="anchor" href="#deploying-and-accessing-the-application"></a>Deploying and Accessing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are ready to deploy the web app using WildFly. From the <code>elytron-oidc-client-scope</code> directory run the following
commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">mvn wildfly:deploy -Dwildfly.port=10000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let’s try accessing our application using <a href="http://localhost:8090/simple-webapp-oidc/" class="bare">http://localhost:8090/simple-webapp-oidc/</a>.</p>
</div>
<div class="paragraph">
<p>Click on "Access Secured Servlet".</p>
</div>
<div class="paragraph">
<p>Now, you’ll be redirected to Keycloak&#8217;s login page. If you click on the url on the search bar, you will see the request
value specified in the URL along with <code>client-id</code>, <code>response_type</code>, <code>redirect_uri</code> and the openid scope. These
parameters are required to be included in the auth request according to the OAuth2 specifications.</p>
</div>
<div class="paragraph">
<p>Log in with <code>Alice</code> and the password that you set when configuring Keycloak.</p>
</div>
<div class="paragraph">
<p>Next, you’ll be redirected back to our application, and you should see the "Secured Servlet" page. That means that we
were able to successfully log in to our application using the Keycloak OpenID provider!</p>
</div>
<div class="sect2">
<h3 id="sending-the-jwt-by-reference"><a class="anchor" href="#sending-the-jwt-by-reference"></a>Sending the JWT by Reference</h3>
<div class="paragraph">
<p>Now try changing the value for <code>authentication-request-format</code> to <code>request_uri</code> and keep everything else the same. You
can do this either in the deployment configuration by editing the <code>oidc.json</code> file or in the subsystem configuration by
typing in the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=authentication-request-format, value=request_uri)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the oidc.json file and deploy it again. If you are using the subsystem configuration, please type in <code>reload</code> to
apply the changes and access <a href="http://localhost:8090/simple-webapp-oidc/" class="bare">http://localhost:8090/simple-webapp-oidc/</a>. You will now see the request_uri appear in the
url. The <code>request_uri</code> parameter is used to send the JWT by reference. The Elytron client sends a PAR request to the
Pushed Authorization Request Endpoint (<a href="http://localhost:8080/realms/myrealm/protocol/openid-connect/ext/par/request" class="bare">http://localhost:8080/realms/myrealm/protocol/openid-connect/ext/par/request</a>),
which creates the request_uri given the JWT Request Object. Once the reference has been made it is only valid for a
certain amount of time specified in the structure returned by the PAR request. After which the request_uri needs to be
regenerated. To learn more about the specifications of the Request Object, read the
<a href="https://openid.net/specs/openid-connect-core-1_0.html#RequestUriParameter">OpenID documentation</a> on passing a Request
Object by reference.</p>
</div>
</div>
<div class="sect2">
<h3 id="sending-a-signed-and-encrypted-request"><a class="anchor" href="#sending-a-signed-and-encrypted-request"></a>Sending a Signed and Encrypted Request</h3>
<div class="sect3">
<h4 id="deployment-configuration-2"><a class="anchor" href="#deployment-configuration-2"></a>Deployment configuration</h4>
<div class="paragraph">
<p>Lastly, lets try to send a signed and encrypted request. For this, please update the <code>oidc.json</code> file to have the
following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
    "client-id" : "myclient",
    "provider-url" : "${env.OIDC_PROVIDER_URL:http://localhost:8080}/realms/myrealm",
    "public-client" : "false",
    "authentication-request-format" : "request_uri",
    "request-object-signing-algorithm" : "RS512",
    "client-keystore-file" : "/path/to/server.keystore",
    "client-keystore-password" : "password",
    "client-key-password" : "password",
    "client-key-alias" : "rsakey",
    "client-keystore-type" : "JKS",
    "ssl-required" : "EXTERNAL",
    "credentials" : {
    	"secret" : "&lt;INSERT CLIENT SECRET&gt;"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need to edit the secret field to add the client secret for your client. On the Keycloak console, navigate to
<code>myclient</code>, and under the <code>Credentials</code> tab, go to <code>Client secret</code> and copy that to your clipboard and place it here as
the value for "secret". Save the file and deploy it again.</p>
</div>
</div>
<div class="sect3">
<h4 id="subsystem-configuration"><a class="anchor" href="#subsystem-configuration"></a>Subsystem Configuration</h4>
<div class="paragraph">
<p>To use subsystem configuration, you can run the following commands to configure the server as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    #Change the signing algorithm
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=request-object-signing-algorithm, value=RS256)

    #add an encryption and content encryption algorithm
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=request-object-encryption-algorithm, value=RSA-OAEP)
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=request-object-content-encryption-algorithm, value=A256GCM)

    #configure the keystore. Change the path to the actual path before running these commands
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=client-keystore-file, value="path/to/jwt.keystore")
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=client-key-password, value=password)
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=client-keystore-password, value=password)
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=client-key-alias, value=rsaKey)
    /subsystem=elytron-oidc-client/secure-deployment=simple-webapp-oidc.war:write-attribute(name=client-keystore-type, value=JKS)
    reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, we are using the keyPairs we created earlier to sign the JWT. The JWT will be signed first and then encrypted
using the public key that Keycloak shared with us. To see what this key looks like, you can either go to
<a href="http://localhost:8080/realms/myrealm/protocol/openid-connect/certs" class="bare">http://localhost:8080/realms/myrealm/protocol/openid-connect/certs</a> or you can go to the Keycloak console and under the
<code>Realm settings</code> tab, click on the <code>keys</code> tab. You will see that there console includes 2 other keys in additional to
the ones on the link. These are the symmetric keys provided by Keycloak which are used by both the client and the server
to sign/verify and encrypt/decrypt.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="note-about-keystores"><a class="anchor" href="#note-about-keystores"></a>Note about Keystores</h3>
<div class="paragraph">
<p>You can follow the same instructions to configure your server to use a PKCS12 type keystore. For Keycloak, the signing
algorithms available are "PS384", "ES384", "RS384", "HS256", "HS512", "ES256", "RS256", "HS384", "ES512","PS256",
"PS512", "RS512" and "none". If you use algorithms that start with "RS" and "PS" to sign the JWT, you will need to use
an RSA key pair. For "ES" type keys, use Elliptical curve keys and as mentioned above, adjust the group name for the
PKCS12 keystore keys to match the SHA value of the algorithms. "none" does not require a keystore and lastly, "HS" keys
require a symmetric key, where the same secret hash is used by the client and the server to sign and verify respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="restoring-the-server"><a class="anchor" href="#restoring-the-server"></a>Restoring the server</h3>
<div class="paragraph">
<p>Once you are ready to restore your server back to what it was, please enter the following on your terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    /subsystem=elytron-oidc-client/secure-deployment=oidc.war:remove</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example has demonstrated how to secure a web application deployed to WildFly by sending the request parameters as a
JWT. For more details on the <code>elytron-oidc-client</code> subsystem, please check out the
<a href="https://docs.wildfly.org/29/Admin_Guide.html#Elytron_OIDC_Client">documentation</a> and for more details on OpenID Connect,
checkout the <a href="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests">OpenID documentation</a> and the
documentation of your OpenID provider. To learn more about the <code>keytool</code> commands and how to generate keys, visit their
<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">documentation</a>.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>
