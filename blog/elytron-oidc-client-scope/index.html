<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Securing a WildFly Application Using OpenID Connect With Additional Scope Values</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Securing a WildFly Application Using OpenID Connect With Additional Scope Values | WildFly Elytron</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Securing a WildFly Application Using OpenID Connect With Additional Scope Values" />
<meta name="author" content="Prarthona Paul" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="WildFly 32 includes the ability to add additional scope values when securing applications using OpenID Connect (OIDC). This new feature is available at the Preview stability level. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OpenID Connect specification indicates that there are other scope values which may be included in the authentication request to ask permission to access additional and specific resources. This guide shows how to configure additional scope values when securing a WildFly app with OpenID Connect on OpenShift." />
<meta property="og:description" content="WildFly 32 includes the ability to add additional scope values when securing applications using OpenID Connect (OIDC). This new feature is available at the Preview stability level. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OpenID Connect specification indicates that there are other scope values which may be included in the authentication request to ask permission to access additional and specific resources. This guide shows how to configure additional scope values when securing a WildFly app with OpenID Connect on OpenShift." />
<link rel="canonical" href="https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/" />
<meta property="og:url" content="https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/" />
<meta property="og:site_name" content="WildFly Elytron" />
<meta property="og:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="twitter:title" content="Securing a WildFly Application Using OpenID Connect With Additional Scope Values" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Prarthona Paul"},"dateModified":"2024-04-29T00:00:00+00:00","datePublished":"2024-04-29T00:00:00+00:00","description":"WildFly 32 includes the ability to add additional scope values when securing applications using OpenID Connect (OIDC). This new feature is available at the Preview stability level. OpenID Connect is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The OpenID Connect specification indicates that there are other scope values which may be included in the authentication request to ask permission to access additional and specific resources. This guide shows how to configure additional scope values when securing a WildFly app with OpenID Connect on OpenShift.","headline":"Securing a WildFly Application Using OpenID Connect With Additional Scope Values","image":"https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/"},"url":"https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                    
                         <a class="mdl-navigation__link highlight-button Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link CVE Reporting-menuitem" href="/wildfly-elytron/security/">CVE Reporting</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
            
                <a class="mdl-navigation__link highlight-sidebar Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
            
            
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
            
                <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
            
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            
            
            
                <a class="mdl-navigation__link CVE Reporting-menuitem" href="/wildfly-elytron/security/">CVE Reporting</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Securing a WildFly Application Using OpenID Connect With Additional Scope Values</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/6ed81e314d6074bbf734abe812f33b05">
        
        <p class="byline">
          By <a href="https://github.com/PrarthonaPaul">Prarthona Paul</a> | April 29, 2024
          <br>
          
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/oidc"> #oidc</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/authentication"> #authentication</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/scopes"> #scopes</a>
            
          
        </p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/&title=Securing a WildFly Application Using OpenID Connect With Additional Scope Values" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Securing a WildFly Application Using OpenID Connect With Additional Scope Values&url=https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Securing a WildFly Application Using OpenID Connect With Additional Scope Values&amp;body=Securing a WildFly Application Using OpenID Connect With Additional Scope Values https://wildfly-security.github.io/wildfly-elytron/blog/elytron-oidc-client-scope/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>WildFly 32 includes the ability to add additional scope values when securing applications using OpenID Connect (OIDC). This new feature is available at the <a href="https://docs.wildfly.org/32/Admin_Guide.html#Feature_stability_levels">Preview stability level</a>. <a href="https://openid.net/developers/how-connect-works/"> OpenID Connect</a> is an identity layer on top of the OAuth 2.0 protocol that makes it possible for a client to verify a user’s identity based on authentication that’s performed by an OpenID provider. The <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest">OpenID Connect specification</a> indicates that there are other scope values which may be included in the authentication request to ask permission to access additional and specific resources. This guide shows how to configure additional scope values when securing a WildFly app with OpenID Connect on OpenShift.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#example-application">Example Application</a></li>
<li><a href="#log-into-the-openshift-cluster">Log Into the OpenShift Cluster</a></li>
<li><a href="#start-keycloak">Start Keycloak</a>
<ul class="sectlevel2">
<li><a href="#openshift-cli">OpenShift CLI</a></li>
<li><a href="#openshift-web-console">OpenShift Web Console</a></li>
</ul>
</li>
<li><a href="#configure-keycloak">Configure Keycloak</a></li>
<li><a href="#add-helm-configuration">Add Helm Configuration</a></li>
<li><a href="#stability-levels-for-openshift-deployment">Stability Levels for OpenShift Deployment</a></li>
<li><a href="#deploy-the-example-application-to-wildfly-on-openshift">Deploy the Example Application to WildFly on OpenShift</a></li>
<li><a href="#behind-the-scenes">Behind the Scenes</a></li>
<li><a href="#get-the-application-url">Get the Application URL</a></li>
<li><a href="#finish-configuring-keycloak">Finish Configuring Keycloak</a></li>
<li><a href="#accessing-the-application">Accessing the Application</a>
<ul class="sectlevel2">
<li><a href="#invalid-scope-values">Invalid Scope Values</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To follow along with this guide, you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roughly 15 minutes</p>
</li>
<li>
<p>Access to an OpenShift cluster (try the Red Hat Developer Sandbox for free)</p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.15/cli_reference/openshift_cli/getting-started-cli.html">OpenShift CLI</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Helm Chart</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example-application"><a class="anchor" href="#example-application"></a>Example Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use a simple web application in this guide that consists of a <a href="https://github.com/wildfly-security-incubator/elytron-examples/blob/main/elytron-oidc-client-scope/src/main/java/org/wildfly/security/examples/SecuredServlet.java">single servlet</a>. We will secure this servlet using OIDC.</p>
</div>
<div class="paragraph">
<p>We will use the example in the <a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/elytron-oidc-client-scope">elytron-oidc-client-scope</a> directory in this repo.</p>
</div>
<div class="paragraph">
<p>To obtain this example, clone the elytron-examples repository to your local machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">git clone git@github.com:wildfly-security-incubator/elytron-examples.git</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="log-into-the-openshift-cluster"><a class="anchor" href="#log-into-the-openshift-cluster"></a>Log Into the OpenShift Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we can deploy our application, we need to log into an OpenShift cluster. You can log in via the OpenShift CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc login -u myUserName</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to log in using the API token, navigate to Developer Sandbox, click on your username at the top right corner, and click on Copy login command. It will redirect you to a page where you can copy your login command and paste it on your terminal. The command will be in this format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc login --token=myToken --server=myServerUrl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have your environment set up with the required tools, we can move on to the next step to build and deploy our application on OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="start-keycloak"><a class="anchor" href="#start-keycloak"></a>Start Keycloak</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will be using Keycloak as our OpenID identity provider.</p>
</div>
<div class="paragraph">
<p>To start a Keycloak server in your project on OpenShift, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc process -f https://raw.githubusercontent.com/keycloak/keycloak-quickstarts/latest/openshift/keycloak.yaml \
    -p KEYCLOAK_ADMIN=admin \                 <i class="conum" data-value="1"></i><b>(1)</b>
    -p KEYCLOAK_ADMIN_PASSWORD=admin \        <i class="conum" data-value="2"></i><b>(2)</b>
    -p NAMESPACE=&lt;PROJECT_NAME&gt; \               <i class="conum" data-value="3"></i><b>(3)</b>
| oc create -f -</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace admin with the user name you would like to use when accessing the Keycloak Administration Console.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace admin with the password you would like to use when accessing the Keycloak Administration Console.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace &lt;PROJECT_NAME&gt; with your project name.
After running the above command, you should see the following output:</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">service/keycloak created
route.route.openshift.io/keycloak created
Warning: apps.openshift.io/v1 DeploymentConfig is deprecated in v4.14+, unavailable in v4.10000+
deploymentconfig.apps.openshift.io/keycloak created.</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will take a few minutes for OpenShift to provision the Keycloak pod and its related resources.</p>
</div>
<div class="paragraph">
<p>You can use the OpenShift CLI or the OpenShift web console, depending on your preference, to check if your Keycloak server has been provisioned.</p>
</div>
<div class="sect2">
<h3 id="openshift-cli"><a class="anchor" href="#openshift-cli"></a>OpenShift CLI</h3>
<div class="paragraph">
<p>To make sure your Keycloak server has been provisioned using the OpenShift CLI, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a little while, check for a message similar to the following message that indicates the pod is ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                READY     STATUS      RESTARTS   AGE
keycloak-1-deploy   0/1       Completed   0          1h
keycloak-1-l9kdx    1/1       Running     0          1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Keycloak server has been provisioned, use the following command to find the URL for your Keycloak instance’s Admin Console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">KEYCLOAK_URL=https://$(oc get route keycloak --template='{{ .spec.host }}') &amp;&amp;
echo "" &amp;&amp;
echo "Keycloak Admin Console:   $KEYCLOAK_URL/admin" &amp;&amp;
echo ""</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openshift-web-console"><a class="anchor" href="#openshift-web-console"></a>OpenShift Web Console</h3>
<div class="paragraph">
<p>To make sure your Keycloak server has been provisioned using the OpenShift web console, navigate to the <strong>Topology</strong> view in the <strong>Developer</strong> perspective. You can click on your <strong>keycloak</strong> app to check its status. Once it is running, you can click on <strong>Open URL</strong> and then access Keycloak’s <strong>Administration Console</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-keycloak"><a class="anchor" href="#configure-keycloak"></a>Configure Keycloak</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the Keycloak Admin Console using the admin username and password you specified earlier.</p>
</li>
<li>
<p>Next, create a realm called <strong>myrealm</strong> and register a client called <strong>myclient</strong> as follows:</p>
<div class="ulist">
<ul>
<li>
<p><strong>General settings</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Client type</strong> (or <strong>Client Protocol</strong>, depending on your keycloak version): <strong>OpenID Connect</strong></p>
</li>
<li>
<p><strong>Client ID</strong>: <strong>myclient</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Capability config</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Authentication flow</strong>: <strong>Standard flow, Direct access grants</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Login Settings</strong>: For the <strong>Valid Redirect URIs</strong>, enter a * for now. We will come back to edit it later.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Navigate to the <strong>Client scopes</strong> tab for <strong>myclient</strong> and change the <strong>Assigned type</strong> for all scope values from <strong>Default</strong> to <strong>Optional</strong>. When <code>Client scopes</code> are set to <code>Default</code>, the claims associated with them are automatically added to the access token you receive. Changing it to <code>Optional</code> ensures that they are not included by default and you will only get access to claims that you request using the scope values you configure. This list of scope are the values that Keycloak allows and it varies for different OpenID providers.</p>
</li>
<li>
<p>Now, click on <strong>Realm roles</strong> and create two roles, <strong>user</strong> and <strong>admin</strong>.</p>
</li>
<li>
<p>Finally, create a user called <strong>alice</strong> whose <strong>First name</strong> is <strong>Alice</strong> and <strong>Last name</strong> is <strong>Smith</strong> and assign her the <strong>user</strong> and <strong>admin</strong> roles. Steps for assigning roles can be found in the <a href="https://www.keycloak.org/docs/latest/server_admin/#proc-assigning-role-mappings_server_administration_guide"> Keycloak documentation</a>. We will be using different scopes to query these pieces of information about Alice.</p>
</li>
<li>
<p>Next, navigate to the <strong>Credentials</strong> tab and create a password for Alice. Toggle the <strong>Temporary</strong> switch off so you are not prompted to update the password after the first login.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-helm-configuration"><a class="anchor" href="#add-helm-configuration"></a>Add Helm Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Obtain the URL for Keycloak.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">KEYCLOAK_URL=https://$(oc get route keycloak --template='{{ .spec.host }}') &amp;&amp;
echo "" &amp;&amp;
echo "Keycloak URL:   $KEYCLOAK_URL" &amp;&amp;
echo ""</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Switch to the charts directory in the <code>elytron-oidc-client-scope</code> example.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cd /PATH/TO/ELYTRON/EXAMPLES/elytron-oidc-client-scope/charts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice there’s a helm.yaml file in this directory with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">build:
  uri: https://github.com/wildfly-security-incubator/elytron-examples.git
  contextDir: elytron-oidc-client-scope
deploy:
  replicas: 1
  env:
    - name: OIDC_PROVIDER_URL
      value: &lt;KEYCLOAK_URL&gt;    <i class="conum" data-value="1"></i><b>(1)</b>
    - name: SERVER_ARGS
      value: "--stability=preview"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace &lt;KEYCLOAK_URL&gt; with the Keycloak URL obtained in the previous command.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stability-levels-for-openshift-deployment"><a class="anchor" href="#stability-levels-for-openshift-deployment"></a>Stability Levels for OpenShift Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The WildFly server now includes different stability levels, that can be associated with functionality. Users can use the <code>--stability</code> argument when staring the WildFly server. Depending on the value of the stability levels, different features are available. You can learn more about stability levels <a href="https://docs.wildfly.org/32/Admin_Guide.html#Feature_stability_levels">here</a>.</p>
</div>
<div class="paragraph">
<p>The <code>scope</code> attribute under the <code>elytron-oidc-client</code> subsystem is a <code>preview</code> level feature, which means in order to access its functionality, the server&#8217;s stability level must be set to <code>preview</code> or lower. When applications are deployed to OpenShift, the WildFly Cloud Galleon Feature Pack is used to provision a server. Therefore, in order to use the scope attribute, we need to provision the server at the <code>preview</code> stability level. This is why we have added the environment variable named <strong>SERVER_ARGS</strong> with a value of <strong>--stability=preview</strong>, which specifies that the provisioned server should be started at the <code>preview</code> stability level. For more information about the server&#8217;s stability levels, please refer to <a href="https://docs.wildfly.org/32/Admin_Guide.html#Feature_stability_levels">WildFly Docs</a>.</p>
</div>
<div class="paragraph">
<p>Additionally, we have used the <code>stability</code> galleon option to specify the stability level used by the feature pack when deploying the application using the tags below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    &lt;galleon-options&gt;
        &lt;stability-level&gt;preview&lt;/stability-level&gt;
    &lt;/galleon-options&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-the-example-application-to-wildfly-on-openshift"><a class="anchor" href="#deploy-the-example-application-to-wildfly-on-openshift"></a>Deploy the Example Application to WildFly on OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you haven’t already installed the WildFly Helm chart, install it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">helm repo add wildfly https://docs.wildfly.org/wildfly-charts/</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you’ve already installed the WildFly Helm Chart, be sure to update it to ensure you have the latest one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">helm repo update</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can deploy our example application to WildFly on OpenShift using the WildFly Helm Chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">helm install oidc-app -f /PATH/TO/ELYTRON/EXAMPLES/elytron-oidc-client-scope/charts/helm.yaml wildfly/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this command specifies the file we updated, <code>helm.yaml</code>, that contains the values needed to build and deploy our application.</p>
</div>
<div class="paragraph">
<p>The application will now begin to build. This will take a couple of minutes.</p>
</div>
<div class="paragraph">
<p>The build can be observed using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get build -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once complete, you can follow the deployment of the application using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get deployment oidc-app -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can check status directly from the OpenShift web console.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="behind-the-scenes"><a class="anchor" href="#behind-the-scenes"></a>Behind the Scenes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While our application is building, let’s take a closer look at our application.</p>
</div>
<div class="paragraph">
<p>Examine the <a href="https://github.com/wildfly-security-incubator/elytron-examples/blob/main/elytron-oidc-client-scope/pom.xml">pom.xml</a> file.</p>
</div>
<div class="paragraph">
<p>Notice that it contains an openshift profile. A profile in Maven lets you create a set of configuration values to customize your application build for different environments. The openshift profile in this example defines a configuration that will be used by the WildFly Helm Chart when provisioning the WildFly server on OpenShift.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;profiles&gt;
    &lt;profile&gt;
            &lt;id&gt;openshift&lt;/id&gt;
            &lt;build&gt;
                &lt;plugins&gt;
                    &lt;plugin&gt;
                        &lt;groupId&gt;org.wildfly.plugins&lt;/groupId&gt;
                        &lt;artifactId&gt;wildfly-maven-plugin&lt;/artifactId&gt;
                        &lt;version&gt;${version.wildfly.maven.plugin}&lt;/version&gt;                  <i class="conum" data-value="1"></i><b>(1)</b>
                        &lt;configuration&gt;
                            &lt;feature-packs&gt;
                                &lt;feature-pack&gt;
                                    &lt;location&gt;org.wildfly:wildfly-galleon-pack:${version.wildfly}&lt;/location&gt;
                                &lt;/feature-pack&gt;
                                &lt;feature-pack&gt;
                                    &lt;location&gt;org.wildfly.cloud:wildfly-cloud-galleon-pack:${version.wildfly.cloud.galleon.pack}&lt;/location&gt;
                                &lt;/feature-pack&gt;
                            &lt;/feature-packs&gt;
                            &lt;layers&gt;
                                &lt;layer&gt;cloud-server&lt;/layer&gt;
                                &lt;layer&gt;elytron-oidc-client&lt;/layer&gt;                      <i class="conum" data-value="2"></i><b>(2)</b>
                            &lt;/layers&gt;
                            &lt;galleon-options&gt;
                                &lt;stability-level&gt;preview&lt;/stability-level&gt;             <i class="conum" data-value="3"></i><b>(3)</b>
                            &lt;/galleon-options&gt;
                            &lt;filename&gt;simple-webapp-oidc.war&lt;/filename&gt;
                        &lt;/configuration&gt;
                        &lt;executions&gt;
                            &lt;execution&gt;
                                &lt;goals&gt;
                                    &lt;goal&gt;package&lt;/goal&gt;
                                &lt;/goals&gt;
                            &lt;/execution&gt;
                        &lt;/executions&gt;
                    &lt;/plugin&gt;
                &lt;/plugins&gt;
            &lt;/build&gt;
        &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>wildfly-maven-plugin</strong> provisions a WildFly server with the specified layers with our application deployed.Version <strong>7.0.0.Beta2</strong> or later must be used to allow for stability levels.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>elytron-oidc-client</strong> automatically adds the native OIDC client subsystem to our WildFly installation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>stability-level</strong> for the feature pack is set to <strong>preview</strong> since we are making use of a preview level feature.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Examine the <a href="https://github.com/wildfly-security-incubator/elytron-examples/blob/main/elytron-oidc-client-scope/src/main/webapp/WEB-INF/oidc.json">oidc.json</a> file, which is used to configure the OIDC client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
    "client-id" : "myclient",
    "provider-url" : "${env.OIDC_PROVIDER_URL:http://localhost:8080}/realms/myrealm",
    "public-client" : "true",
    "scope" : "profile email roles web-origins microprofile-jwt offline_access",
    "principal-attribute" : "preferred_username",
    "ssl-required" : "EXTERNAL"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we have specified the scope values to be <strong>profile</strong>, <strong>email</strong>, <strong>web-origins</strong>, <strong>microprofile-jwt</strong>, <strong>roles</strong> and <strong>offline_access</strong> in a space delimited list inside the <strong>oidc.json</strong> file. <code>profile</code>, <code>email</code> and <code>offline_access</code> are OpenID built-in scopes, while <code>web-origin</code>, <code>microprofile-jwt</code> and <code>roles</code> are Keycloak specific scope values and allow access to additional claims. You can read the descriptions under the <code>Client scope</code> tab for <code>myclient</code> to learn more about the purpose of these scope values.</p>
</div>
<div class="paragraph">
<p>Next, navigate to the OIDC application&#8217;s <code>web.xml</code> file and look for the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    &lt;login-config&gt;
        &lt;auth-method&gt;OIDC&lt;/auth-method&gt;         <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/login-config&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Setting the <code>auth-method</code> to <code>OIDC</code> specifies that our application will use OpenID Connect to authenticate users.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-the-application-url"><a class="anchor" href="#get-the-application-url"></a>Get the Application URL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the WildFly server has been provisioned, use the following command to find the URL for your example application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    SIMPLE_WEBAPP_OIDC_URL=https://$(oc get route oidc-app --template='{{ .spec.host }}') &amp;&amp;
    echo "" &amp;&amp;
    echo "Application URL: $SIMPLE_WEBAPP_OIDC_URL/simple-webapp-oidc"  &amp;&amp;
    echo "Valid redirect URI: $SIMPLE_WEBAPP_OIDC_URL/simple-webapp-oidc/secured/*" &amp;&amp;
    echo ""</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="finish-configuring-keycloak"><a class="anchor" href="#finish-configuring-keycloak"></a>Finish Configuring Keycloak</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From your <strong>myclient</strong> client in the Keycloak Administration Console, in the client settings, set <strong>Valid Redirect URI</strong> to the Valid redirect URI that was output in the previous section and then click <strong>Save</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accessing-the-application"><a class="anchor" href="#accessing-the-application"></a>Accessing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, let’s try accessing our application using the application URL.</p>
</div>
<div class="paragraph">
<p>Click on <strong>Access Secured Servlet</strong>.</p>
</div>
<div class="paragraph">
<p>Now, you’ll be redirected to Keycloak to log in. If you click on the url on the search bar, you will see the scope values specified in the <code>redirect-uri</code> field with the different scope values separated by a <code>+</code>. You will also notice that a new scope value, <code>openid</code>, has been added. This indicates that we are going to be using OpenID Connect to authenticate the user.</p>
</div>
<div class="paragraph">
<p>Log in with <strong>alice</strong> and the password that you set when configuring Keycloak.</p>
</div>
<div class="paragraph">
<p>Next, you’ll be redirected back to our application and you should see the <strong>Secured Servlet</strong> page. That means that we were able to successfully log in to our application using the Keycloak OpenID provider!</p>
</div>
<div class="paragraph">
<p>This page will display the current principal, and a list of claim values obtained using the scope values you configured. This is what it will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Current Principal 'alice'

Claims received using additional scope values:

By configuring the "profile" scope, the "given_name" and "family_name" claims are present in the access token and have values : Alice and Smith

By configuring the "email" scope, the "email_verified" claim is present in the access token and has value : false

By configuring the "roles" scope, the "realm_access" claim is present in the access token and has value : {roles=[default-roles-myrealm, offline_access, admin, uma_authorization, user]}

By configuring the "microprofile-jwt" scope, the "groups" claim is present in the access token and has value : [default-roles-myrealm, offline_access, admin, uma_authorization, user]

By configuring the "web-origins" scope, the "allowed-origins" claim is present in the access token and has value : [http://localhost:8090]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the value for Current Principal may be different, and can be replaced by the unique client id assigned by keycloak.</p>
</div>
<div class="paragraph">
<p>Notice that there are no claims obtained using the <code>offline_access</code> scope. To learn more about what this scope value does, please refer to the <a href="https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess"> OpenID Documentation </a>.</p>
</div>
<div class="sect2">
<h3 id="invalid-scope-values"><a class="anchor" href="#invalid-scope-values"></a>Invalid Scope Values</h3>
<div class="paragraph">
<p>Different OpenID providers have their own set of valid scope values and they vary depending on the OpenID provider. Try changing the scope values to <code>INVALID_SCOPE</code> inside the oidc.json file.</p>
</div>
<div class="paragraph">
<p>Deploy and access the webapp again using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">helm upgrade oidc-app -f charts/helm.yaml wildfly/wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>INVALID_SCOPE</code> is not one of the acceptable scope values, you will now see a <code>Bad request</code> page instead of being redirected to the Keycloak login page. You will notice that the url now contains
<code>error=invalid_scope&amp;error_description=Invalid+scopes</code>
This indicates that your authentication request was rejected because it contains invalid scope values.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example has demonstrated how to secure a WildFly application deployed to OpenShift using additional scope values. For more details on the <code>elytron-oidc-client</code> subsystem, please check out the <a href="https://docs.wildfly.org/32/Admin_Guide.html#Elytron_OIDC_Client"> documentation </a> and for more details on OpenID Connect, checkout the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims"> OpenID documentation </a> and the documentation of your OpenID provider.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resources"><a class="anchor" href="#resources"></a>Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.wildfly.org/32/Getting_Started_on_OpenShift.html">Getting Started with WildFly on OpenShift</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.15/cli_reference/openshift_cli/getting-started-cli.html">OpenShift CLI</a></p>
</li>
<li>
<p><a href="https://docs.wildfly.org/32/Getting_Started_on_OpenShift.html#helm-charts">WildFly Helm Chart</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/getting-started/getting-started-openshift">Getting started with Keycloak on OpenShift</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/server_admin/index.html">Keycloak Server Administration Guide</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/securing_apps/#_oidc">Using OpenID Connect to secure applications and services</a></p>
</li>
<li>
<p><a href="https://docs.wildfly.org/32/Admin_Guide.html#Feature_stability_levels">Feature stability levels</a></p>
</li>
<li>
<p><a href="https://docs.wildfly.org/32/Galleon_Guide.html#WildFly_Galleon_feature-packs">WildFly Galleon feature-packs</a></p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>
